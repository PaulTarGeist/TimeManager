<template>
    <div id="vue-chartmaker-template">
        <h3 class="jumbotron" v-if="defaultParams.title">{{defaultParams.title}}</h3>
        <p class="jumbotron text-danger" v-if="error">{{error}}</p>
        <table :id="idTable" :class="'chaarts ' + defaultParams.type" v-if="show">
            <caption v-if="defaultParams.description">{{defaultParams.description}}</caption>
            <tbody><slot></slot></tbody>
        </table>
    </div>
</template>

<script>
import $ from 'jquery'

const CHART_TYPE_BAR = 'bar'
const CHART_TYPE_PIE = 'pie'
const ID_CHART_TABLE = 'vue-chartmaker-chart'

const chartsType = [
    CHART_TYPE_BAR,
    CHART_TYPE_PIE
]

export default {
    name: 'ChartMaker',
    data: function() {
        return {
            show: false,
            error: "",
            defaultParams: {
                id: null,
                title: "",
                description: "",
                xMax: null,
                type: null
            },
            typeBar: CHART_TYPE_BAR,
            typePie: CHART_TYPE_PIE
        }
    },
    props: [
        'params'
    ],
    methods: {
        fillParams: function() {
            for (var name in this.params) {
                this.defaultParams[name] = this.params[name]
            }
            if (this.defaultParams.id === null) {
                this.setError("Invalid field \"id\". Please enter a valid id for the chart.")
                return false
            }
            if (this.defaultParams.type === null || !this.isValidType(this.defaultParams.type)) {
                this.setError("Invalid field \"type\". Please enter a valid chart type : '" + chartsType.join("', '") + "'")
                return false
            }
            if (this.defaultParams.type === CHART_TYPE_BAR && (this.defaultParams.xMax === null || this.defaultParams.xMax < 1)) {
                this.setError("Invalid field \"xMax\". Please enter an integer greater than or equal to 1.")
                return false
            }
            return true
        },
        setError: function(error) {
            this.error = "vue-chartmaker error : " + error
        },
        isValidType: function(type) {
            for (var i = 0; i < chartsType.length; i++) {
                if (type === chartsType[i])
                    return true
            }
            return false
        },
        fillChart: function() {
            if (!this.show)
                return
            if (this.defaultParams.type === CHART_TYPE_BAR) {
                $('#' + this.idTable).css('--scale', this.defaultParams.xMax);
            }
            if (this.defaultParams.type === CHART_TYPE_PIE) {
                var start = 0;
                $('#' + this.idTable + ' td').each(function() {
                    let percent = $(this).css('--value')
                    let style = {}
                    if (percent !== "") {
                        percent = parseInt(percent, 10)
                        if (percent < 25) {
                            // Empty
                        } else if (percent < 50) {
                            style['--lt-25'] = 0
                            style['--gt-25'] = 1
                            style['--lt-50'] = 1
                            style['--gt-50'] = 0
                        } else if (percent < 75) {
                            style['--lt-25'] = 0
                            style['--gt-25'] = 1
                            style['--lt-50'] = 0
                            style['--gt-50'] = 1
                            style['--lt-75'] = 1
                            style['--gt-75'] = 0
                        } else {
                            style['--lt-25'] = 0
                            style['--gt-25'] = 1
                            style['--lt-50'] = 0
                            style['--gt-50'] = 1
                            style['--lt-75'] = 0
                            style['--gt-75'] = 1
                            style['--lt-100'] = 1
                        }
                        for (var name in style) {
                            $(this).css(name, style[name]);
                        }
                        $(this).css('--start', start);
                        start += percent
                        let parent = $(this).parent()
                        let label = $(this).parent().children("th").html()
                        parent.css('--term', "'" + label + "'");
                    }
                });
            }
        }
    },
    computed: {
        idTable: function() {
            return ID_CHART_TABLE + '-' + this.defaultParams.id
        }
    },
    created() {
        this.show = this.fillParams()
        this.$nextTick(() => {
            this.fillChart()
        })
                
    }
}
</script>

<style scoped src="./css/charts.css">
</style>

<style scoped src="./css/bootstrap.min.css">
</style>
